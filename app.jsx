// Полное содержимое для файла app.jsx

const rawText = `ЛЕГЕНДЫ ДОСАННЫ — КНИГА ПЕРВАЯ...Легенды Досанны, книга первая - Взмах крыла Автор идеи Чистяков Артем
Глава первая: Наследник престола.
"Проснитесь!" - раздался вдруг голос.
"Кто потревожил мой сон и зачем?".
"Это я, ваше величество, главный лечец" - сказал Главный лечец замка.
"А, это ты Доррис, что-то стряслось?" - сказал король Лорос 3.
"Ваша жена..."
Не давая договорить король перебил его.
"Что стряслось с Эллиз?" - сказал король вскакивая с кровати
"Королева Эллиз рожает, по нашим сведениям должен быть мальчик" - сказал отходя в сторону Доррис.
"Так это же отличная новость! - воскликнул король, - И зачем было так пугать меня?"
"Роды преждевременные мой король, очень высока вероятность смерти ребёнка" - с опаской сказал лечец.
"Я не допущу этого" - мрачно сказал король выходя из своих покоев.
Лечец последовал за ним
"Вы оповестили Северную Цитадель о родах?" - спросил король у Дорриса.
"Да ваша светлость, мы послали двух сорнов в Цитадель"
"Хорошо" - ответил король направляясь к родильне.
"Постойте король!" - воскликнул лечец
Король вопросительно посмотрел на Дорриса.
"сорны быстрые птицы, долетят за минут 10, но люди не птицы"
"Ближе к делу" - перебивая его сказал король.
"Даже при самом удачном раскладе Джады прибудут только через час, а королева рожает уже сейчас" - с небольшой раздражённостью сказал лечец.
Король распахнул дверь родильной комнаты, где на кровати лежала его жена, он вбежал к ней и встал на колени беря её за руку.
"Эллиз, любовь моя, я рядом, не переживай, все будет хоро..."
Короля перебили крики его жены.
"Доррис!" - воскликнул король, "Неужели нету способа облегчить её мучения?" - сказал с надеждой король.
"Нет мой король, будь вы и на первых родах может быть и знали бы" - мрачно сказал лечец.
"Ты сам знаешь что я не мог" - грустно сказал король.
"Неужели у нас в округе нету ни одного Джада?!" - грозно спросил король у Дорриса.
"Я могу послать гонцов на поиски мой король" - сказал лечец
"Некогда уже!" - воскликнула вдруг повитуха, "Она уже рожает, надо сделать все чтобы мы не потеряли хотя бы её!"
"Эй ты" - сказал король одному из стражников, "Срочно иди в лазарет и приведи всех лекарей что могут помочь с родами твоей королевы!" - сказал король.
"Да ваше величество" - сказал стражник выбегая из комнаты.
"Мне привести вашу дочь мой король?" - спросил короля Доррис.
"Нет, не стоит, не хочу чтобы она это видела"- ответил король.
"Прошу отойти в сторону ваше величество" - сказал главный лечец.
Король покорно отошел в сторону. Лечец потрогал лоб и шею королевы.
"Температура повышена, пульс высокий, но при родах это вполне нормально"
"Итак ваше величество" - сказал Главный Лечец обращаясь к королеве, "Вам придётся сейчас сильно тужиться, будет очень больно, но вы справитесь во второй раз, я в вас верю" - сказал Доррис Эллиз, "Окси" - сказал лечец повитухе, "Помогайте ей, это по вашей специальности".
"Почему нельзя никак облегчить её страдания?" - спросил король у Дорриса.
"Видите ли ваше величество, роды это не просто какой-то процесс, это зарождение жизни, природная энергия матери выходит из нее и передается её ребёнку, давая ему жизнь" - поэтично сказал лечец.
"Но в чем же тогда проблема ранних родов?" - с недопониманием сказал король.
"А потому, что природная энергия начнет выходить в определенный срок, а если ребенок выйдет раньше, он может не получить природную энергию" — сказал раздражённо Доррис.
"Я советую вам начать молиться, вдруг духи природы услышат вас, и оставят жизни этих бедных созданий вам" - завершил лечец.
Король послушался лечца, и начал молиться духам природы о здравии его жены, и живом сыне или дочери.
"Святые пятеро, прошу не забирайте энергию моей жены и ребенка, возьмите сегодня других, затем вам заплатят сполна, лишь прошу подарите им жизнь!" - чуть ли не крича, на коленях произнес молитву Король.
"Головка уже видна!" - крикнула вдруг повитуха "Хорошо идет, как нож сквозь масло" - радостно пошутила Окси.
Наконец прибежал охранник со всевозможными лечцами. Все они заполонили комнату, стараясь помочь королеве. Спустя полчаса королева родила сына, как сказал главный лечец - "Крупный жеребец, здоровый, на удивлние!". Малышу отрезали пуповину, и завязали в пупок, затем положили на грудь матери, тот с радостью начал сосать молоко.
Король с радостью и облечением поцеловал свою жену, и сказал малышу - "Ты станешь великим королём, что во всей Досанне будут тебя знать и уважать!".
"Ваше величество, нужно отметить ребёнка в список населения Пиковой земли, а также пригласить глав других государств на его зарождение, а ещё..."
"Для начала Доррис, разбуди мою дочь и отправь Сорнов идущим к нам из Цитадели Джадам, что королева успешно родила, затем уже разберёмся" - перебил главного лечца король.
"Эллиз как ты?" - спросил у королевы её любящий муж.
"Меня трудно убить, ты сам знаешь" - тихо и с улыбкой сказала Эллиз.
Малыша назвали Виннон 3 своего имени, в честь его дедушки Виннона 2, под прозвищем "кровавый властитель".
"Хэй! Там сорн летит!" - сказал один из Джадов которые ехали в Пиковые земли на роды королевы.
"Пресвятые пятеро, неужели мы опоздали" - с отчаянием сказал верховный Джад.
Все пять Джадов остановились и взяли письмо у сорна. В нем было написано - "Королева Эллиз успешно родила мальчика раньше срока, рост 45,1 лв (лазорев, средний размер иглы лазорев, кустарников растущих по всей Досанне, равняется около 1,2 см), вес 4 исы (иссены, средняя маса превращённого в гирьку метала иссен, диаметром в 40мм, 1 ис равен около 1 килограмму), полное имя и принадлежность к роду: Виннон Виттер 3, дата и время рождения: 391 г.п.в.в. (год после Великой Войны) 2 месяц духа земли, 32 день Инферноса, 12 часов 32 минуты. Ждем вас на его зарождении, церемония пройдёт 3 дня Титана утром, как только прибудут короли Носстоса, Ночных земель и Гассонии. Просьба прибыть как можно быстрее для оценки природной энергии королевы. С уважением Верховный Лечец Доррис от имени короля Лороса 3." - зачитал верховный Джад вслух.
"Хвала пятерым, принц живой!" воскликнул один из Джадов.
Все стали радоваться, желать королю королеве и принцу долгой жизни, но их радость прервал верховный Джад, - "не время останавливаться, мы уже близко к столице, а королева только что перенесла роды, нам стоит поторопиться,и тогда возможно духи наградят нас щедрой выпивкой!".
"Да!" - воскликнули радостно все, садясь на локеев.
"Локс!" - сказал верховный Джад, и локеи тронулись с места, поскакав к Пиковым землям.
"Хей пап, тут сорн принес письмо, судя по печати из Синнесы!"
"Дай посмотрю" - сказал, забирая письмо у дочки, король Гассонии.
"Королева Эллиз родила принца!" - радостно воскликнул король, - "Нас приглашают на церемонию зарождения, хочешь поехать со мной?", - "Как никак это возможно твой будущий муж, хе-хе" - шутливо сказал король.
"Паааап, ну не начинай, он только родился а ты уже говоришь о таком, и да, конечно я поеду, я очень скучаю по Венноре" - ответила королю его принцесса.
Тут Доррис вернулся.
"Ваше величество, ваша дочь отказывается вставать" — сказал Доррис королю Лорасу.
"Ладно, следите за состоянием Эллиз, а я схожу за Веннорой" — с небольшим недовольством произнёс король, вставая с колен и направляясь к двери.
Дойдя до покоев его дочери, он постучал в массивную дверь. Ответа не последовало. Тогда король открыл дверь, войдя в покои дочери.
"Веннора, Эллиз родила тебе брата, пойдем скорее" — произнёс король окидывая взглядом комнату.
Но Венноры в ней не было, зато король увидел спущенную с окна верёвку, закрепленную на ножке её кровати.
"Ах ты мелкая невоспитанная дева" — с недовольством сказал король, - "Уже 16 лет отроду, а все никак не перестанет вести себя как дитя".
"Красиво тут, не так-ли принцесса?"
"Красиво, сир Лонос, а главное спокойно, нет всех этих бегающих лечцов, из-за рождения моего братца" — сказала Веннора.
"Вы когда-нибудь плавали на корабле принцесса?"
"Нет, к сожалению не доводилось, отец не выпускает меня за пределы Пиковых земель, сижу тут, как жёлтая хватовертка вне пустыни" — с досадой и небольшой злостью сказала принцесса.
Рыцарь взял её за руку и с гордостью сказал, - "Я, сир Лонос из семьи Ваксбуров, клянусь вам принцесса, что когда мы с вами поженимся я увезу вас в странствие на корабле, и больше никто не будет вас держать в клетке!".
"Хи-хи, вы очень добры сир Лонос".
"Рад это слышать моя принцесса" — с улыбкой на лице сказал рыцарь.
"Называйте меня просто Веннора, всё-таки вы служили мне еще с моих пятых именин".
"Как скажете прин.. то есть Веннора!"
Принцесса разразилось громким смехом, - "Вы такой забавный сир Лонос, хи-хи, как насчет прогуляться на пиковом склоне?"
"Это очень опасно Веннора, ты и сама знаешь что ходить туда простым людям строго запрещено" — с опаской сказал сир Лонос.
"Но я и не простая людь, то есть, ну..." - запнулась принцесса.
"Я понял о чем вы, принцесса, я согласен пройтись с вами, но только если вы будите держаться подле меня!" - грозно, но по доброму говорил рыцарь.
"Ладно-ладно, защитничек, хи-хи".
Принцесса взяла сира Лоноса за руку, и они направились на пиковый склон.
Они шли около замка, внизу острые скалы бились волны.
"Вы только послушайте сир Лонос, как прекрасно звучит!" - с неподдельной радостью воскликнула принцесса.
"Да, море красиво, но и очень опасно, мой брат, да воссоединиться он с природой, утонул во время плаваний, сильный шторм перевернул его корабль" — с грустью произнес сир Лонос.
"Ой, простите сир Лонос, я не знала, сожалею о вашем брате" — сочувствующие сказала принцесса.
"Спасибо Веннора, ты очень добра ко мне".
"Ой да ладно, хихи" - радостно сказала принцесса, - "Ах, смотрите, там летит огромный молиз!" - сказала принцесса закинув голову в небо.
"Хах, действительно здоровый, видимо на пиках прилетел погреться" — с небольшой усмешкой сказал Лонос.
И действительно, вскоре молиз сел на одну из тысяч пик, расположенных в море и около него, снизу холма. Его большие зеленые глаза напоминали джунгли, а большой клюв был похож на эти самые пики, только шире.
"Невероятно!" - воскликнул вдруг сир Лонос.
"Что такое мой сир?" - спросила у него принцесса.
"Я сначала думал мне показалось, и это просто Лоррайские лучи отражаются, но нет, действительно золотой!" - с ещё большей радостью воскликнул Лонос.
Приглядевшись королева сказала нежно, -"Хм, и вправду золотой, мой сир!"
"А я о чем... Стоп, как ты меня назвала?" - немного смущённо ответил Лонос.
Принцесса лишь рассмеялась, и сняла с Лоноса шлем.
"Здесь никого нет, справа пики, слева скала, тебе пока не нужен шлем, сир Лонос" — немного кокетливо сказала принцесса.
"Как скажете Веннора" — сказал он, продолжая идти по тропе.
Он вдруг остановился.
"Принцесса, я давно хотел вам сказать..." - немного с опаской говорил Лонос.
"Ну так говори, мой сир" — всё также кокетливо и нежно сказала принцесса.
"Я... Я"
"Я последний раз спрашиваю, как вы умудрились упустить двух взрослых Лосей?" - надрываясь орал король Лорас, - "Они же, подери их духи, огромные!" - продолжал негодовать король.
"Простите нас ваше величество, мы не ожидали что они смогут убежать от нас" — извинялся один из подданых.
"До ближайшего леса еще 1445 грат! (мера длины, равная ста лв или около 120см, была создана для упрощения счета больших расстояний)" — все еще злился король, «Ну кааак, как вы могли их упустить, еще и в день рождения моего сына, кошмар!".
"Прошу ваше величество, простите нас, мы сейчас соберем людей и поймаем еще больше, и других животных, если сможем может даже поймаем вирса, мы знаем вы любите его мясо, наш король" — оправдывался подданный.
"Ладно, идите, но еще раз что-то такое произойдет и я клянусь, я скину вас с Игловой Башни!" - разругался король.
Подданные побежали прочь.
"Ваше величество, вы не можете всем грозить скинуть их с Игловой Башни, это плохо влияет на вашу репутацию" — сказал лорд десница.
"Жонтэ, я лучше знаю как нужно заставлять простой народ что-то делать, страх — знак величия!" - воскликнул король.
"Вовсе нет ваше вел..."
"Ты мне ещё по пререкайся, сгинь с глаз моих долой, и найди в конце концов Веннору" — грозно сказал король.
"Да, простите ваше величество, сию минуту, стража!" - сказал лорд десница, и удалился из тронного зала.
"Нет ну что за день?" - вопрошал сам себя король.
"День рождения твоего наследника, вот что за день" — сказала зашедшая королева Эллиз.
"Любовь моя, как ты, как Виннон?" - сказал Король своей жене.
"Виннон отлично, вон кушает сейчас, я пока что держусь, но живот сильно болит" — ответила королева.
"Ты говорила лечцам?"
"Да, сказали что это послеродовое растяжение живота, и скоро должно пройти".
"Хорошо".
Король и королева болтали в тронном зале еще минут 30.`; // Оставьте здесь ваш полный текст, я его сократил для краткости

// Функции-помощники (без изменений)
function splitIntoSections(text){
  const lines = text.split("\n");
  const sections = [];
  let current = { title: "Введение", content: "Здесь представлены отрывки из фэнтезийного повествования , 
    сосредоточенные на королевской семье Досанны, особенно на принцессе Венноре. Первая часть подробно описывает
    преждевременные роды королевы Эллиз и рождение принца Виннона, за которым следует церемония зарождения,
      призванная наделить младенца жизненной силой.
      Параллельно развивается сюжетная линия тайной романтики принцессы Венноры с рыцарем Лоносом и её нежелательного,
      но политически выгодного брака с принцем Эйроном из Носстоса. 
      Второй источник анализирует древние традиции, мистические верования и социальные группы, такие как "тени" (шпионы),
      раскрывая интриги при дворе, включая политические махинации короля Лораса, шпионаж главного лечца Дорриса и его последующее изгнание, 
      а также личные драмы и их широкие последствия для королевств." };
  for(let i=0;i<lines.length;i++){
    const line = (lines[i]||"").trim();
    if(!line){ current.content += "\n"; continue; }
    if(/^(ЛЕГЕНДЫ ДОСАННЫ|ДЕТАЛЬНОЕ РУКОВОДСТВО|Обзор|Ключевые темы|Вопросы для самопроверки|Викторина|Глоссарий)/i.test(line)
       || /^(Глава\s*\d+|ГЛАВА\s*\d+|Вопрос:|Часть\s*\d+)/i.test(line)
       || (line === line.toUpperCase() && line.length < 70)){
      if(current.content.trim() || current.title) sections.push(current);
      current = { title: line, content: "" };
    } else {
      current.content += (current.content ? "\n" : "") + (lines[i]||"");
    }
  }
  if(current.content.trim() || current.title) sections.push(current);
  return sections.map((s,i)=> Object.assign({id:i}, s));
}
function splitByQuery(text,q){
  if(!q) return [{text, match:false}];
  const lower = text.toLowerCase(), ql = q.toLowerCase(), res = []; let idx=0;
  while(true){
    const f = lower.indexOf(ql, idx);
    if(f === -1){ res.push({text: text.slice(idx), match:false}); break; }
    if(f > idx) res.push({text: text.slice(idx,f), match:false});
    res.push({text: text.slice(f, f+ql.length), match:true});
    idx = f + ql.length;
  }
  return res;
}
function renderHighlighted(text,q){
  const parts = splitByQuery(text,q);
  return (<div style={{whiteSpace:"pre-wrap"}}>{parts.map((p,i)=> p.match ? <mark key={i} className="px-0">{p.text}</mark> : <span key={i}>{p.text}</span>)}</div>);
}
function extractGlossary(text){
  const res = []; const idx = text.indexOf("Глоссарий");
  if(idx !== -1){
    const tail = text.slice(idx).split("\n");
    for(let i=1;i<tail.length;i++){ const line=(tail[i]||"").trim(); if(!line) continue; const parts=line.split(":"); if(parts.length>=2) res.push({term:parts[0].trim(), def:parts.slice(1).join(":").trim()}); if(res.length>40) break; }
  }
  if(res.length) return res;
  const words = Array.from(new Set(text.match(/\b[А-ЯЁ][а-яёA-ЯЁ]+\b/g) || [])).slice(0,30);
  return words.map(w=>({term:w, def:"(определение уточните)"}));
}

// Новый компонент галереи с зумом
function ImageGallery() {
   const images = [
    { src: "/img/engraving_1.png", thumb: "/img/engraving_1.png", subHtml: "<h4>Гравюра I</h4>" },
    { src: "/img/engraving_2.png", thumb: "/img/engraving_2.png", subHtml: "<h4>Гравюра II</h4>" },
    { src: "/img/engraving_3.png", thumb: "/img/engraving_3.png", subHtml: "<h4>Гравюра III</h4>" },
    { src: "/img/engraving_4.png", thumb: "/img/engraving_4.png", subHtml: "<h4>Гравюра IV</h4>" },
    { src: "/img/engraving_5.png", thumb: "/img/engraving_5.png", subHtml: "<h4>Гравюра V</h4>" },
     { src: "/img/engraving_6.png", thumb: "/img/engraving_6.png", subHtml: "<h4>Карта мира Досанны</h4>" },
    { src: "/img/user_photo.jpg", thumb: "/img/user_photo.jpg", subHtml: "<h4>Фото пользователя</h4>" }
  ];

  React.useEffect(() => {
    const galleryContainer = document.getElementById('lightgallery');
    if (galleryContainer) {
     const lg = lightGallery(galleryContainer, {
        plugins: [window.lgZoom], // ИЗМЕНЕНИЕ: Добавили 'window.'
        speed: 500,
        licenseKey: '0000-0000-000-0000',
        mousewheel: true,
        download: false
      });
      return () => {
        lg.destroy();
      };
    }
  }, []);

  return (
    <section className="page-card">
        <h2 className="text-lg font-semibold mb-2">Галерея иллюстраций</h2>
        <div id="lightgallery" className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            {images.map((image, index) => (
              <a 
                href={image.src} 
                key={index} 
                className="img-card block cursor-zoom-in"
                data-sub-html={image.subHtml}
              >
                <img 
                  alt={image.cap} 
                  src={image.thumb} 
                  className="w-full h-auto block" 
                />
                <figcaption className="p-2 text-sm opacity-80">{image.cap || `Image ${index+1}`}</figcaption>
              </a>
            ))}
        </div>
    </section>
  );
}

// Основной компонент вашего сайта
function LegendsOfDosanna(){
  const [query, setQuery] = React.useState("");
  const [dark, setDark] = React.useState(false);
  const [paperStyle, setPaperStyle] = React.useState(()=> localStorage.getItem('dosanna_paper') || 'light');
  React.useEffect(()=> localStorage.setItem('dosanna_paper', paperStyle), [paperStyle]);

  const sections = React.useMemo(()=> splitIntoSections(rawText), []);
  const [activeId, setActiveId] = React.useState(0);
  const [animateId, setAnimateId] = React.useState(null);
  const [notes, setNotes] = React.useState(()=>{ try{ return JSON.parse(localStorage.getItem("dosanna_notes_final")||"{}"); } catch(e){ return {}; } });
  const [bookmarks, setBookmarks] = React.useState(()=>{ try{ return JSON.parse(localStorage.getItem("dosanna_bmarks_final")||"[]"); } catch(e){ return []; } });
  React.useEffect(()=> localStorage.setItem("dosanna_notes_final", JSON.stringify(notes)), [notes]);
  React.useEffect(()=> localStorage.setItem("dosanna_bmarks_final", JSON.stringify(bookmarks)), [bookmarks]);

  const filtered = React.useMemo(()=>{ if(!query.trim()) return sections; const q = query.toLowerCase(); return sections.filter(s=> s.title.toLowerCase().includes(q) || s.content.toLowerCase().includes(q)); }, [query, sections]);
  
  function saveNote(id, text){ setNotes(n=> Object.assign({}, n, {[id]: text })); }
  function toggleBookmark(id){ setBookmarks(b => b.includes(id) ? b.filter(x=>x!==id) : [...b, id]); }

  function exportJSON(){ const blob = new Blob([JSON.stringify(notes, null, 2)], {type:"application/json"}); const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "dosanna_notes.json"; a.click(); }
  function exportCSV(){ let csv = "Section,Note\n"; Object.keys(notes).forEach(id=>{ const title = (sections[id] && sections[id].title) ? sections[id].title.replace(/"/g,'""') : ("Раздел " + id); const body = (notes[id]||"").replace(/"/g,'""').replace(/\n/g,"\\n"); csv += `"${title}","${body}"\n`; }); const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([csv], {type:"text/csv;charset=utf-8;"})); a.download = "dosanna_notes.csv"; a.click(); }
  function exportMD(){ let md = "# Заметки по «Легендам Досанны»\n\n"; Object.keys(notes).forEach(id=>{ const title = (sections[id] && sections[id].title) ? sections[id].title : ("Раздел " + id); md += `## ${title}\n\n${notes[id]||''}\n\n---\n\n`; }); const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([md], {type:"text/markdown"})); a.download = "dosanna_notes.md"; a.click(); }
  function speak(text){ if(!window.speechSynthesis){ alert("TTS не поддерживается браузером"); return; } window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text || ""); u.lang = "ru-RU"; window.speechSynthesis.speak(u); }
  function stopSpeak(){ if(window.speechSynthesis) window.speechSynthesis.cancel(); }

  function goTo(id){ setActiveId(id); setAnimateId(id); setTimeout(()=> setAnimateId(null), 700); const el = document.getElementById(`sec-${id}`); if(el) el.scrollIntoView({behavior:"smooth", block:"start"}); }

  return (
    <div className={(paperStyle==="dark"?"paper-dark ":"paper-light ")+(dark ? "bg-neutral-900 text-neutral-100" : "text-neutral-900")}>
      <div className="max-w-7xl mx-auto grid grid-cols-12 gap-4">
        <header className="col-span-12 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 p-3">
          <h1 className="text-2xl font-bold drop-shadow">Легенды Досанны — Учебный сайт</h1>
          <div className="flex items-center gap-2">
            <button className="px-3 py-1 rounded border" onClick={()=> setPaperStyle(paperStyle==="light"?"dark":"light")}>{paperStyle==="light"?"Тёмная бумага":"Светлая бумага"}</button>
            <button className="px-3 py-1 rounded border" onClick={()=> setDark(d=>!d)}>{dark ? "Светлая тема UI" : "Тёмная тема UI"}</button>
            <button className="px-3 py-1 rounded border" onClick={exportJSON}>JSON</button>
            <button className="px-3 py-1 rounded border" onClick={exportCSV}>CSV</button>
            <button className="px-3 py-1 rounded border" onClick={exportMD}>MD</button>
          </div>
        </header>

        <aside className="sidepanel col-span-12 lg:col-span-3 glass rounded p-3 border h-max lg:sticky lg:top-4">
          <div className="mb-3 flex gap-2">
            <input value={query} onChange={e=>setQuery(e.target.value)} placeholder="Поиск…" className="w-full px-2 py-1 rounded border" />
          </div>
          <h3 className="font-semibold mb-2">Оглавление</h3>
          <ul className="space-y-1 text-sm max-h-[45vh] overflow-auto pr-1">
            {sections.map((s) => (
              <li key={s.id}>
                <button className={"toc-btn w-full text-left " + (activeId===s.id ? "font-bold" : "")} onClick={() => goTo(s.id)}>
                  {s.title}
                </button>
              </li>
            ))}
          </ul>
          <div className="mt-4">
            <h4 className="font-semibold">Закладки</h4>
            <ul className="text-sm space-y-1 max-h-[25vh] overflow-auto pr-1">
              {bookmarks.length === 0 && <li className="text-xs opacity-60">Нет закладок</li>}
              {bookmarks.map((id) => (
                <li key={id}>
                  <button className="underline" onClick={() => goTo(id)}>
                    {sections[id]?.title || `Раздел ${id}`}
                  </button>
                </li>
              ))}
            </ul>
          </div>
        </aside>

        <main className="col-span-12 lg:col-span-6 space-y-4">
          {filtered.map((s) => (
            <article key={s.id} id={`sec-${s.id}`}
              className={"page-card " + (animateId===s.id ? "page-enter-active" : "")}>
              <div className="flex items-start justify-between">
                <h2 className="text-lg font-semibold">{s.title}</h2>
                <div className="flex gap-2">
                  <button onClick={() => toggleBookmark(s.id)} className="px-2 py-1 border rounded text-sm">
                    {bookmarks.includes(s.id) ? "Удалить закладку" : "Закладка"}
                  </button>
                </div>
              </div>
              <div className="prose prose-sm max-w-none">{renderHighlighted(s.content, query)}</div>
              <div className="mt-2 border-t pt-2">
                <label className="block text-sm font-medium">Заметки</label>
                <textarea
                  value={notes[s.id] || ""}
                  onChange={(e) => saveNote(s.id, e.target.value)}
                  className="w-full mt-1 p-2 rounded border min-h-[80px] text-sm"
                  placeholder="Ваши заметки по этому разделу…"
                />
                <div className="flex gap-2 mt-2">
                  <button onClick={() => speak(notes[s.id] || "")} className="px-2 py-1 border rounded text-sm">🎙 Читать вслух</button>
                  <button onClick={stopSpeak} className="px-2 py-1 border rounded text-sm">■ Стоп</button>
                </div>
              </div>
            </article>
          ))}
          
          {/* ИЗМЕНЕНО: Старая галерея заменена на новую */}
          <ImageGallery />

        </main>

        <aside className="col-span-12 lg:col-span-3 glass rounded p-3 border h-max lg:sticky lg:top-4 space-y-4">
          <section>
            <h3 className="font-semibold">Мини‑викторина</h3>
            <Quiz />
          </section>
          <section>
            <h3 className="font-semibold">Глоссарий (быстрый)</h3>
            <Glossary />
          </section>
        </aside>

        <footer className="col-span-12 text-xs opacity-70 py-2">Сайт сгенерирован на основе загруженных файлов. Данные заметок хранятся локально.</footer>
      </div>
    </div>
  );
}

function Quiz(){
  const [quiz] = React.useState(() => {
    const q = []; const lines = rawText.split("\n");
    for(let i=0;i<lines.length;i++){
      const line = (lines[i]||"").trim();
      if(line.startsWith("Вопрос:")){
        const rest = line.replace(/^Вопрос:\s*/i, "");
        let answer = "";
        if(/Ответ:/i.test(line)) answer = line.split(/Ответ:\s*/i)[1] || "";
        else for(let j=i+1;j<Math.min(i+5, lines.length); j++){ if((lines[j]||"").trim().startsWith("Ответ:")){ answer = (lines[j]||"").trim().replace(/^Ответ:\s*/i, ""); break; } }
        q.push({question: rest, answer});
      }
    }
    return q;
  });
  const [idx, setIdx] = React.useState(0); const [show, setShow] = React.useState(false);
  if(quiz.length === 0) return <p className="text-sm opacity-60">Вопросы не найдены.</p>;
  return (<div className="mt-2"><div className="text-sm font-medium">{quiz[idx].question}</div>{show && <div className="mt-2 p-2 border rounded text-sm bg-white/60">{quiz[idx].answer || "(ответ не найден)"}</div>}<div className="flex gap-2 mt-2"><button onClick={()=>setShow(s=>!s)} className="px-2 py-1 border rounded text-sm">{show?"Скрыть":"Показать ответ"}</button><button onClick={()=>{ setShow(false); setIdx(i => (i+1) % Math.max(quiz.length,1)); }} className="px-2 py-1 border rounded text-sm">Следующий</button></div></div>);
}

function Glossary(){
  const items = React.useMemo(() => extractGlossary(rawText).slice(0,15), []);
  return (<div className="text-sm mt-2 space-y-1">{items.map((g, idx) => (<div key={idx}><div className="font-medium">{g.term}</div><div className="text-xs opacity-80">{g.def}</div></div>))}</div>);
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(LegendsOfDosanna));
